{% extends 'base.html' %} {% set active_page = 'home' %} {% block title %}Hệ
thống điểm danh thông minh{% endblock %} {% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Left Column - Camera -->
    <div class="col-lg-6 col-md-12 mb-4">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0">
            <i class="fas fa-video me-2"></i>Camera trực tiếp
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="video-container">
            <img
              id="video-stream"
              src="/video_feed"
              alt="Video feed"
              class="video-stream"
              onerror="console.error('Failed to load video feed'); this.style.border='2px solid red';"
              onload="console.log('Video feed loaded successfully');"
            />
            <div class="video-overlay">
              <div class="recognition-status" id="recognition-status">
                <i class="fas fa-eye me-1"></i>Đang nhận diện...
              </div>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <div class="row g-2 align-items-center">
            <div class="col-md-4">
              <button id="quick-register-btn" class="btn btn-primary w-100">
                <i class="fas fa-user-plus me-1"></i>Đăng ký nhanh
              </button>
            </div>
            <div class="col-md-4">
              <button id="reload-faces" class="btn btn-success w-100">
                <i class="fas fa-sync-alt me-1"></i>Cập nhật dữ liệu
              </button>
            </div>
            <div class="col-md-4">
              <div class="d-flex align-items-center justify-content-center">
                <label class="me-2 mb-0 fw-bold">Camera:</label>
                <div class="form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="toggle-camera"
                    style="width: 3em; height: 1.5em; cursor: pointer"
                  />
                  <label
                    class="form-check-label"
                    for="toggle-camera"
                    id="camera-switch-label"
                    >Tắt</label
                  >
                </div>
              </div>
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-12">
              <div
                class="camera-status d-flex align-items-center justify-content-center"
              >
                <span class="status-indicator me-2"></span>
                <span id="camera-status-text">Đang kiểm tra...</span>
              </div>
            </div>
          </div>
          <div id="reload-result" class="mt-2 text-center"></div>
        </div>
      </div>
    </div>

    <!-- Right Column - Attendance List -->
    <div class="col-lg-6 col-md-12 mb-4">
      <div class="card h-100">
        <div class="card-header bg-success text-white">
          <h5 class="card-title mb-0">
            <i class="fas fa-list-check me-2"></i>Danh sách điểm danh hôm nay
            <span class="badge bg-light text-dark ms-2" id="attendance-count"
              >{{ attendance|length if attendance else 0 }}</span
            >
          </h5>
        </div>
        <div class="card-body p-0">
          {% if attendance and attendance|length > 0 %}
          <div
            class="table-responsive"
            style="max-height: 500px; overflow-y: auto"
          >
            <table class="table table-hover mb-0">
              <thead class="table-light sticky-top">
                <tr>
                  <th width="5%">#</th>
                  <th width="30%">Họ tên</th>
                  <th width="25%">Giờ vào</th>
                  <th width="20%">Thời gian có mặt</th>
                  <th width="15%">Trạng thái</th>
                  <th width="5%">Hành động</th>
                </tr>
              </thead>
              <tbody id="attendance-table-body">
                {% for row in attendance %}
                <tr data-student-id="{{ row.student_id }}">
                  <td>{{ loop.index }}</td>
                  <td>
                    <div class="d-flex align-items-center">
                      <div
                        class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                      >
                        {{ row.full_name[0].upper() if row.full_name else 'N' }}
                      </div>
                      <div>
                        <div class="fw-bold">
                          {{ row.full_name if row.full_name else 'Không có tên'
                          }}
                        </div>
                        <small class="text-muted"
                          >ID: {{ row.student_id if row.student_id else 'N/A'
                          }}</small
                        >
                      </div>
                    </div>
                  </td>
                  <td>
                    <div>
                      <i class="fas fa-clock me-1"></i>
                      {{ row.timestamp[11:19] if row.timestamp else 'N/A' }}
                    </div>
                    <small class="text-muted">
                      {% if row.checkout_time %}
                      <i class="fas fa-sign-out-alt me-1"></i>Ra: {{
                      row.checkout_time[11:19] }} {% endif %}
                    </small>
                  </td>
                  <td>
                    <span
                      class="badge bg-info duration-badge"
                      data-duration="{{ row.duration_minutes if row.duration_minutes else 0 }}"
                    >
                      <i class="fas fa-hourglass-half me-1"></i>
                      {% if row.duration_minutes %} {% if row.duration_minutes
                      >= 60 %} {{ (row.duration_minutes // 60) }}h {{
                      (row.duration_minutes % 60) }}p {% else %} {{
                      row.duration_minutes }} phút {% endif %} {% else %} 0 phút
                      {% endif %}
                    </span>
                  </td>
                  <td>
                    <span
                      class="badge {% if row.status == 'Đang có mặt' %}bg-success{% elif row.status == 'Đã rời' %}bg-secondary{% else %}bg-warning{% endif %} status-badge"
                    >
                      {% if row.status == 'Đang có mặt' %}
                      <i class="fas fa-user-check me-1"></i>
                      {% elif row.status == 'Đã rời' %}
                      <i class="fas fa-sign-out-alt me-1"></i>
                      {% else %}
                      <i class="fas fa-user-clock me-1"></i>
                      {% endif %} {{ row.status }}
                    </span>
                  </td>
                  <td>
                    <button
                      class="btn btn-sm btn-outline-primary"
                      onclick="viewDetails('{{ row.full_name if row.full_name else 'N/A' }}')"
                      title="Xem chi tiết"
                    >
                      <i class="fas fa-eye"></i>
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center py-5">
            <i class="fas fa-user-times fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Chưa có sinh viên nào điểm danh</h5>
            <p class="text-muted">
              Hệ thống sẽ tự động nhận diện và điểm danh khi có sinh viên xuất
              hiện trước camera.
            </p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row mt-4">
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card bg-primary text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title">Tổng sinh viên</h6>
              <h3 class="mb-0" id="total-students">0</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-users fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card bg-success text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title">Đã điểm danh</h6>
              <h3 class="mb-0" id="attended-students">
                {{ attendance|length if attendance else 0 }}
              </h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-check-circle fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card bg-warning text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title">Tỷ lệ điểm danh</h6>
              <h3 class="mb-0" id="attendance-rate">0%</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-percentage fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card bg-info text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title">Đang có mặt</h6>
              <h3 class="mb-0" id="active-presence-count">0</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-user-check fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card bg-secondary text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title">Thời gian TB</h6>
              <h3 class="mb-0" id="avg-duration">0p</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-clock fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Active Presence Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h5 class="card-title mb-0">
            <i class="fas fa-users-between-lines me-2"></i>Sinh viên đang có mặt
            trong lớp
            <span
              class="badge bg-light text-dark ms-2"
              id="active-presence-badge"
              >0</span
            >
          </h5>
        </div>
        <div class="card-body">
          <div id="active-presence-list" class="row">
            <div class="col-12 text-center text-muted">
              <i class="fas fa-user-clock fa-3x mb-3 opacity-50"></i>
              <p>Chưa có sinh viên nào đang được phát hiện trong lớp</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- System Status Section (Hidden/Collapsed) -->
  <div class="row mb-4" style="display: none">
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card bg-dark text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title">Trạng thái hệ thống</h6>
              <h6 class="mb-0" id="system-status">
                <i class="fas fa-circle text-success me-1"></i>Hoạt động
              </h6>
            </div>
            <div class="align-self-center">
              <i class="fas fa-server fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Register Modal -->
<div
  class="modal fade"
  id="quickRegisterModal"
  tabindex="-1"
  aria-labelledby="quickRegisterModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="quickRegisterModalLabel">
          <i class="fas fa-user-plus me-2"></i>Đăng ký khuôn mặt nhanh
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="quickRegisterForm">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="reg-student-id" class="form-label"
                  >Mã sinh viên <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="reg-student-id"
                  name="student_id"
                  required
                  placeholder="Ví dụ: SV001"
                />
              </div>
              <div class="mb-3">
                <label for="reg-full-name" class="form-label"
                  >Họ và tên <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="reg-full-name"
                  name="full_name"
                  required
                  placeholder="Ví dụ: Nguyễn Văn A"
                />
              </div>
              <div class="mb-3">
                <label for="reg-class-name" class="form-label">Lớp</label>
                <input
                  type="text"
                  class="form-control"
                  id="reg-class-name"
                  name="class_name"
                  placeholder="Ví dụ: CNTT K15"
                />
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label"
                  >Ảnh khuôn mặt <span class="text-danger">*</span></label
                >
                <div class="text-center">
                  <video
                    id="webcam-preview"
                    class="border rounded mb-2"
                    width="100%"
                    height="240"
                    autoplay
                    style="
                      display: none;
                      max-width: 320px;
                      transform: scaleX(-1);
                    "
                  ></video>
                  <canvas
                    id="capture-canvas"
                    class="border rounded mb-2"
                    width="320"
                    height="240"
                    style="display: none"
                  ></canvas>
                  <img
                    id="captured-image"
                    class="border rounded mb-2"
                    width="320"
                    height="240"
                    style="display: none; transform: scaleX(-1)"
                    alt="Captured face"
                  />
                  <div
                    id="camera-placeholder"
                    class="border rounded d-flex align-items-center justify-content-center bg-light"
                    style="width: 320px; height: 240px; margin: 0 auto"
                  >
                    <i class="fas fa-camera fa-3x text-muted"></i>
                  </div>
                </div>
                <div class="d-grid gap-2 mt-2">
                  <button
                    type="button"
                    class="btn btn-outline-primary"
                    id="start-webcam-btn"
                  >
                    <i class="fas fa-video me-1"></i>Bật Camera
                  </button>
                  <button
                    type="button"
                    class="btn btn-success"
                    id="capture-btn"
                    style="display: none"
                  >
                    <i class="fas fa-camera me-1"></i>Chụp ảnh
                  </button>
                  <button
                    type="button"
                    class="btn btn-warning"
                    id="retake-btn"
                    style="display: none"
                  >
                    <i class="fas fa-redo me-1"></i>Chụp lại
                  </button>
                  <div class="text-center">
                    <small class="text-muted">hoặc</small>
                  </div>
                  <input
                    type="file"
                    class="form-control"
                    id="reg-face-image"
                    name="face_image"
                    accept="image/*"
                  />
                </div>
              </div>
            </div>
          </div>
          <div id="register-result" class="mt-3"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>Hủy
        </button>
        <button type="button" class="btn btn-primary" id="submit-register-btn">
          <i class="fas fa-save me-1"></i>Đăng ký
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // Wait for DOM to be ready
  document.addEventListener("DOMContentLoaded", () => {
    // Reload faces functionality
    const reloadBtn = document.getElementById("reload-faces");
    if (reloadBtn) {
      reloadBtn.addEventListener("click", async () => {
        const btn = document.getElementById("reload-faces");
        const result = document.getElementById("reload-result");
        const icon = btn.querySelector("i");

        btn.disabled = true;
        icon.className = "fas fa-spinner fa-spin me-1";
        result.innerHTML =
          '<div class="alert alert-info mb-0"><i class="fas fa-spinner fa-spin me-1"></i>Đang cập nhật...</div>';

        try {
          const res = await fetch("/update_faces", { method: "POST" });
          const text = await res.text();
          if (res.ok) {
            result.innerHTML = `<div class="alert alert-success mb-0"><i class="fas fa-check me-1"></i>${text}</div>`;
            setTimeout(() => location.reload(), 1500);
          } else {
            result.innerHTML = `<div class="alert alert-danger mb-0"><i class="fas fa-exclamation-triangle me-1"></i>Lỗi: ${text}</div>`;
          }
        } catch (err) {
          result.innerHTML = `<div class="alert alert-danger mb-0"><i class="fas fa-exclamation-triangle me-1"></i>Lỗi: ${err.message}</div>`;
        } finally {
          btn.disabled = false;
          icon.className = "fas fa-sync-alt me-1";
        }
      });
    }

    // Refresh attendance
    const refreshBtn = document.getElementById("refresh-attendance");
    if (refreshBtn) {
      refreshBtn.addEventListener("click", () => {
        location.reload();
      });
    }

    // View details function
    window.viewDetails = function (name) {
      alert(`Chi tiết điểm danh của: ${name}`);
    };

    // Camera toggle switch functionality
    const toggleSwitch = document.getElementById("toggle-camera");
    const switchLabel = document.getElementById("camera-switch-label");
    const statusText = document.getElementById("camera-status-text");

    async function updateCameraStatus() {
      try {
        const response = await fetch("/api/camera/status");
        const data = await response.json();
        toggleSwitch.checked = data.enabled;
        switchLabel.textContent = data.enabled ? "Bật" : "Tắt";
        if (statusText) {
          statusText.textContent = data.enabled
            ? "Camera đang hoạt động"
            : "Camera đã tắt";
        }
      } catch (error) {
        console.error("Error checking camera status:", error);
      }
    }

    if (toggleSwitch) {
      toggleSwitch.addEventListener("change", async function () {
        const isEnabled = this.checked;
        switchLabel.textContent = isEnabled ? "Đang bật..." : "Đang tắt...";

        try {
          const response = await fetch("/api/camera/toggle", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          });
          const data = await response.json();

          if (data.success) {
            switchLabel.textContent = data.enabled ? "Bật" : "Tắt";
            if (statusText) {
              statusText.textContent = data.enabled
                ? "Camera đang hoạt động"
                : "Camera đã tắt";
            }
            if (data.enabled) {
              setTimeout(() => location.reload(), 500);
            }
          }
        } catch (error) {
          console.error("Error toggling camera:", error);
          this.checked = !isEnabled;
          switchLabel.textContent = !isEnabled ? "Bật" : "Tắt";
        }
      });

      // Initial status check
      updateCameraStatus();
      // Poll camera status every 10s instead of 5s to reduce requests
      setInterval(updateCameraStatus, 10000);
    }

    // Quick Register Modal functionality
    const quickRegisterBtn = document.getElementById("quick-register-btn");
    const quickRegisterModal = new bootstrap.Modal(
      document.getElementById("quickRegisterModal")
    );
    let webcamStream = null;
    let capturedImageData = null;

    if (quickRegisterBtn) {
      quickRegisterBtn.addEventListener("click", async () => {
        // Tắt camera chính trước khi mở modal
        const toggleSwitch = document.getElementById("toggle-camera");
        if (toggleSwitch && toggleSwitch.checked) {
          try {
            // Gọi API để tắt camera
            const response = await fetch("/api/camera/toggle", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
            });
            const data = await response.json();

            if (data.success && !data.enabled) {
              toggleSwitch.checked = false;
              const switchLabel = document.getElementById(
                "camera-switch-label"
              );
              if (switchLabel) switchLabel.textContent = "Tắt";

              // Đợi 1 giây để camera giải phóng hoàn toàn
              await new Promise((resolve) => setTimeout(resolve, 1000));
              console.log("Camera chính đã tắt hoàn toàn");
            }
          } catch (error) {
            console.error("Error turning off main camera:", error);
          }
        }

        quickRegisterModal.show();
        document.getElementById("quickRegisterForm").reset();
        document.getElementById("register-result").innerHTML = "";
        capturedImageData = null;
        // Reset camera UI
        document.getElementById("webcam-preview").style.display = "none";
        document.getElementById("capture-canvas").style.display = "none";
        document.getElementById("captured-image").style.display = "none";
        document.getElementById("camera-placeholder").style.display = "flex";
        document.getElementById("start-webcam-btn").style.display = "block";
        document.getElementById("capture-btn").style.display = "none";
        document.getElementById("retake-btn").style.display = "none";
      });
    }

    // Webcam controls
    const startWebcamBtn = document.getElementById("start-webcam-btn");
    const captureBtn = document.getElementById("capture-btn");
    const retakeBtn = document.getElementById("retake-btn");
    const webcamPreview = document.getElementById("webcam-preview");
    const captureCanvas = document.getElementById("capture-canvas");
    const capturedImage = document.getElementById("captured-image");
    const cameraPlaceholder = document.getElementById("camera-placeholder");

    if (startWebcamBtn) {
      startWebcamBtn.addEventListener("click", async () => {
        try {
          // Liệt kê tất cả các camera
          const devices = await navigator.mediaDevices.enumerateDevices();
          const videoDevices = devices.filter(
            (device) => device.kind === "videoinput"
          );

          console.log("Available cameras:", videoDevices);

          // Loại bỏ camera điện thoại/external
          const laptopCameras = videoDevices.filter((device) => {
            const label = device.label.toLowerCase();
            // Loại trừ camera điện thoại/external
            return (
              !label.includes("phone") &&
              !label.includes("mobile") &&
              !label.includes("droidcam") &&
              !label.includes("iriun") &&
              !label.includes("ip camera") &&
              !label.includes("usb")
            );
          });

          console.log("Laptop cameras:", laptopCameras);

          // Chọn camera laptop đầu tiên hoặc camera đầu tiên trong danh sách
          let selectedCamera =
            laptopCameras.length > 0 ? laptopCameras[0] : videoDevices[0];

          console.log(
            "Selected camera:",
            selectedCamera ? selectedCamera.label : "None"
          );

          if (!selectedCamera) {
            throw new Error("Không tìm thấy camera nào");
          }

          // Mở camera với deviceId cụ thể
          const constraints = {
            video: {
              width: 320,
              height: 240,
              deviceId: { exact: selectedCamera.deviceId },
            },
          };

          webcamStream = await navigator.mediaDevices.getUserMedia(constraints);
          webcamPreview.srcObject = webcamStream;
          webcamPreview.style.display = "block";
          cameraPlaceholder.style.display = "none";
          startWebcamBtn.style.display = "none";
          captureBtn.style.display = "block";
        } catch (error) {
          console.error("Camera error:", error);
          alert("Không thể truy cập camera laptop. Lỗi: " + error.message);
        }
      });
    }

    if (captureBtn) {
      captureBtn.addEventListener("click", () => {
        const context = captureCanvas.getContext("2d");
        captureCanvas.width = 320;
        captureCanvas.height = 240;

        // Flip lại canvas để ảnh không bị đảo ngược (vì video đã flip bằng CSS)
        context.save();
        context.scale(-1, 1);
        context.drawImage(webcamPreview, -320, 0, 320, 240);
        context.restore();

        capturedImageData = captureCanvas.toDataURL("image/jpeg", 0.8);
        capturedImage.src = capturedImageData;

        // Stop webcam
        if (webcamStream) {
          webcamStream.getTracks().forEach((track) => track.stop());
          webcamStream = null;
        }

        // Update UI
        webcamPreview.style.display = "none";
        capturedImage.style.display = "block";
        captureBtn.style.display = "none";
        retakeBtn.style.display = "block";
      });
    }

    if (retakeBtn) {
      retakeBtn.addEventListener("click", () => {
        capturedImageData = null;
        capturedImage.style.display = "none";
        cameraPlaceholder.style.display = "flex";
        retakeBtn.style.display = "none";
        startWebcamBtn.style.display = "block";
      });
    }

    // Submit registration
    const submitRegisterBtn = document.getElementById("submit-register-btn");
    if (submitRegisterBtn) {
      submitRegisterBtn.addEventListener("click", async () => {
        const form = document.getElementById("quickRegisterForm");
        const formData = new FormData(form);
        const resultDiv = document.getElementById("register-result");

        console.log("Submit clicked");
        console.log(
          "capturedImageData:",
          capturedImageData ? "exists" : "null"
        );

        // Validate
        if (!formData.get("student_id") || !formData.get("full_name")) {
          resultDiv.innerHTML =
            '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-1"></i>Vui lòng điền đầy đủ thông tin bắt buộc!</div>';
          return;
        }

        // Check if has image (captured or uploaded)
        if (capturedImageData) {
          console.log("Using captured image data");
          formData.append("image_data", capturedImageData);
        } else {
          const faceImageFile = formData.get("face_image");
          console.log("face_image file:", faceImageFile);
          console.log(
            "face_image file.name:",
            faceImageFile ? faceImageFile.name : "null"
          );
          if (!faceImageFile || !faceImageFile.name) {
            console.log("No image provided - showing error");
            resultDiv.innerHTML =
              '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-1"></i>Vui lòng chụp ảnh hoặc upload ảnh khuôn mặt!</div>';
            return;
          }
        }

        console.log("Proceeding to submit...");
        // Submit
        submitRegisterBtn.disabled = true;
        submitRegisterBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin me-1"></i>Đang đăng ký...';

        try {
          const response = await fetch("/api/quick-register", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          if (response.ok && data.success) {
            resultDiv.innerHTML = `<div class="alert alert-success"><i class="fas fa-check me-1"></i>${data.message}</div>`;
            setTimeout(() => {
              quickRegisterModal.hide();
              location.reload();
            }, 1500);
          } else {
            resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-1"></i>${
              data.error || "Đăng ký thất bại"
            }</div>`;
          }
        } catch (error) {
          resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-1"></i>Lỗi: ${error.message}</div>`;
        } finally {
          submitRegisterBtn.disabled = false;
          submitRegisterBtn.innerHTML =
            '<i class="fas fa-save me-1"></i>Đăng ký';
        }
      });
    }

    // Clean up webcam when modal closes
    document
      .getElementById("quickRegisterModal")
      .addEventListener("hidden.bs.modal", async () => {
        // Dừng webcam trong modal
        if (webcamStream) {
          webcamStream.getTracks().forEach((track) => track.stop());
          webcamStream = null;
          console.log("Webcam modal đã dừng");
        }

        // Đợi một chút để đảm bảo webcam đã giải phóng
        await new Promise((resolve) => setTimeout(resolve, 500));

        // Bật lại camera chính
        const toggleSwitch = document.getElementById("toggle-camera");
        if (toggleSwitch && !toggleSwitch.checked) {
          try {
            const response = await fetch("/api/camera/toggle", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
            });
            const data = await response.json();

            if (data.success && data.enabled) {
              toggleSwitch.checked = true;
              const switchLabel = document.getElementById(
                "camera-switch-label"
              );
              if (switchLabel) switchLabel.textContent = "Bật";
              console.log("Camera chính đã được bật lại");

              // Reload trang để hiển thị camera
              setTimeout(() => location.reload(), 500);
            }
          } catch (error) {
            console.error("Error turning on main camera:", error);
          }
        }
      });
  });

  // Cập nhật thời gian có mặt real-time
  function updateAttendanceDuration() {
    const durationBadges = document.querySelectorAll(".duration-badge");
    durationBadges.forEach((badge) => {
      const currentMinutes = parseInt(
        badge.getAttribute("data-duration") || "0"
      );
      const newMinutes = currentMinutes + 1;
      badge.setAttribute("data-duration", newMinutes);

      // Format hiển thị
      let displayText = "";
      if (newMinutes >= 60) {
        const hours = Math.floor(newMinutes / 60);
        const mins = newMinutes % 60;
        displayText = `${hours}h ${mins}p`;
      } else {
        displayText = `${newMinutes} phút`;
      }

      badge.innerHTML = `<i class="fas fa-hourglass-half me-1"></i>${displayText}`;
    });
  }

  // Cập nhật trạng thái và danh sách điểm danh
  async function refreshAttendanceList() {
    try {
      const response = await fetch("/api/attendance/today");
      const data = await response.json();

      if (data.success && data.data) {
        const tbody = document.getElementById("attendance-table-body");
        if (tbody) {
          // Rebuild table
          tbody.innerHTML = "";
          data.data.forEach((row, index) => {
            const tr = document.createElement("tr");
            tr.setAttribute("data-student-id", row.student_id);

            // Format duration
            let durationText = "0 phút";
            if (row.duration_minutes) {
              if (row.duration_minutes >= 60) {
                const hours = Math.floor(row.duration_minutes / 60);
                const mins = row.duration_minutes % 60;
                durationText = `${hours}h ${mins}p`;
              } else {
                durationText = `${row.duration_minutes} phút`;
              }
            }

            // Status badge
            let statusClass = "bg-warning";
            let statusIcon = "fa-user-clock";
            if (row.status === "Đang có mặt") {
              statusClass = "bg-success";
              statusIcon = "fa-user-check";
            } else if (row.status === "Đã rời") {
              statusClass = "bg-secondary";
              statusIcon = "fa-sign-out-alt";
            }

            tr.innerHTML = `
              <td>${index + 1}</td>
              <td>
                <div class="d-flex align-items-center">
                  <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                    ${row.full_name ? row.full_name[0].toUpperCase() : "N"}
                  </div>
                  <div>
                    <div class="fw-bold">${
                      row.full_name || "Không có tên"
                    }</div>
                    <small class="text-muted">ID: ${
                      row.student_id || "N/A"
                    }</small>
                  </div>
                </div>
              </td>
              <td>
                <div><i class="fas fa-clock me-1"></i>${
                  row.timestamp ? row.timestamp.substring(11, 19) : "N/A"
                }</div>
                ${
                  row.checkout_time
                    ? `<small class="text-muted"><i class="fas fa-sign-out-alt me-1"></i>Ra: ${row.checkout_time.substring(
                        11,
                        19
                      )}</small>`
                    : ""
                }
              </td>
              <td>
                <span class="badge bg-info duration-badge" data-duration="${
                  row.duration_minutes || 0
                }">
                  <i class="fas fa-hourglass-half me-1"></i>${durationText}
                </span>
              </td>
              <td>
                <span class="badge ${statusClass} status-badge">
                  <i class="fas ${statusIcon} me-1"></i>${row.status}
                </span>
              </td>
              <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewDetails('${
                  row.full_name || "N/A"
                }')" title="Xem chi tiết">
                  <i class="fas fa-eye"></i>
                </button>
              </td>
            `;
            tbody.appendChild(tr);
          });

          // Update count
          const countBadge = document.getElementById("attendance-count");
          if (countBadge) {
            countBadge.textContent = data.data.length;
          }
        }
      }
    } catch (error) {
      console.error("Error refreshing attendance list:", error);
    }
  }

  // Cập nhật mỗi phút cho sinh viên chưa checkout
  setInterval(() => {
    const tbody = document.getElementById("attendance-table-body");
    if (tbody) {
      const rows = tbody.querySelectorAll("tr");
      rows.forEach((row) => {
        const statusBadge = row.querySelector(".status-badge");
        const durationBadge = row.querySelector(".duration-badge");

        // Chỉ cập nhật cho sinh viên "Đang có mặt"
        if (
          statusBadge &&
          statusBadge.textContent.includes("Đang có mặt") &&
          durationBadge
        ) {
          const currentMinutes = parseInt(
            durationBadge.getAttribute("data-duration") || "0"
          );
          const newMinutes = currentMinutes + 1;
          durationBadge.setAttribute("data-duration", newMinutes);

          let displayText = "";
          if (newMinutes >= 60) {
            const hours = Math.floor(newMinutes / 60);
            const mins = newMinutes % 60;
            displayText = `${hours}h ${mins}p`;
          } else {
            displayText = `${newMinutes} phút`;
          }

          durationBadge.innerHTML = `<i class="fas fa-hourglass-half me-1"></i>${displayText}`;
        }
      });
    }
  }, 60000); // Mỗi 60 giây (1 phút)

  // Làm mới danh sách điểm danh mỗi 30 giây
  setInterval(refreshAttendanceList, 30000);

  // Cập nhật danh sách sinh viên đang có mặt
  async function updateActivePresence() {
    try {
      const response = await fetch("/api/presence/active");
      const data = await response.json();

      if (data.success) {
        const activeList = document.getElementById("active-presence-list");
        const activeBadge = document.getElementById("active-presence-badge");
        const activeCount = document.getElementById("active-presence-count");

        if (activeBadge) activeBadge.textContent = data.count;
        if (activeCount) activeCount.textContent = data.count;

        if (activeList) {
          if (data.count === 0) {
            activeList.innerHTML = `
              <div class="col-12 text-center text-muted">
                <i class="fas fa-user-clock fa-3x mb-3 opacity-50"></i>
                <p>Chưa có sinh viên nào đang được phát hiện trong lớp</p>
              </div>
            `;
          } else {
            let html = "";
            data.data.forEach((student) => {
              const isActive = student.seconds_since_seen < 30;
              const statusClass = isActive ? "success" : "warning";
              const statusIcon = isActive ? "fa-check-circle" : "fa-clock";

              // Format duration
              let durationText = `${student.duration_minutes} phút`;
              if (student.duration_minutes >= 60) {
                const hours = Math.floor(student.duration_minutes / 60);
                const mins = student.duration_minutes % 60;
                durationText = `${hours}h ${mins}p`;
              }

              html += `
                <div class="col-md-4 col-sm-6 mb-3">
                  <div class="card border-${statusClass}">
                    <div class="card-body">
                      <div class="d-flex align-items-center">
                        <div class="avatar-md bg-${statusClass} text-white rounded-circle d-flex align-items-center justify-content-center me-3">
                          <i class="fas fa-user fa-2x"></i>
                        </div>
                        <div class="flex-grow-1">
                          <h6 class="mb-1">${student.name}</h6>
                          <small class="text-muted">ID: ${
                            student.student_id
                          }</small>
                          <div class="mt-2">
                            <span class="badge bg-${statusClass}">
                              <i class="fas ${statusIcon} me-1"></i>
                              ${
                                isActive
                                  ? "Đang phát hiện"
                                  : "Chưa thấy " +
                                    student.seconds_since_seen +
                                    "s"
                              }
                            </span>
                          </div>
                          <div class="mt-1">
                            <small class="text-muted">
                              <i class="fas fa-hourglass-half me-1"></i>Có mặt: ${durationText}
                            </small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              `;
            });
            activeList.innerHTML = html;
          }
        }
      }
    } catch (error) {
      console.error("Error updating active presence:", error);
    }
  }

  // Cập nhật thống kê
  async function updateStatistics() {
    try {
      const response = await fetch("/api/statistics");
      const data = await response.json();

      const totalStudents = document.getElementById("total-students");
      const attendedStudents = document.getElementById("attended-students");
      const attendanceRate = document.getElementById("attendance-rate");
      const avgDuration = document.getElementById("avg-duration");

      if (totalStudents) totalStudents.textContent = data.total_students || 0;
      if (attendedStudents)
        attendedStudents.textContent = data.attended_students || 0;
      if (attendanceRate)
        attendanceRate.textContent = `${data.attendance_rate || 0}%`;

      if (avgDuration) {
        const mins = data.avg_duration_minutes || 0;
        if (mins >= 60) {
          const hours = Math.floor(mins / 60);
          const minutes = mins % 60;
          avgDuration.textContent = `${hours}h ${minutes}p`;
        } else {
          avgDuration.textContent = `${mins}p`;
        }
      }
    } catch (error) {
      console.error("Error updating statistics:", error);
    }
  }

  // Cập nhật active presence mỗi 5 giây
  setInterval(updateActivePresence, 5000);
  // Cập nhật thống kê mỗi 10 giây
  setInterval(updateStatistics, 10000);

  // Gọi ngay lần đầu
  updateActivePresence();
  updateStatistics();
</script>
{% endblock %}
