{% extends "base.html" %} {% block title %}{{ _('reports.title') }} - {{
_('app_name') }}{% endblock %} {% block extra_css %}
<style>
  .stat-card h3 {
    font-size: 2.2rem;
  }
  .table-responsive {
    max-height: 500px;
  }
  .progress-bar-initial {
    width: 0%;
  }
</style>
{% endblock %} {% block content %}
<div class="container-fluid" id="reports-container">
  {% set page_title = _('reports.page_title') %} {% set page_subtitle =
  _('reports.page_subtitle') %} {% set page_icon = 'fas fa-chart-line' %} {%
  include 'components/page_header.html' %}

  <!-- Tab Navigation -->
  <ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item" role="presentation">
      <button
        class="nav-link active"
        id="report-tab"
        data-bs-toggle="tab"
        data-bs-target="#report-content"
        type="button"
        role="tab"
      >
        <i class="fas fa-chart-bar me-2"></i>{{ _('reports.attendance_report')
        }}
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content">
    <div class="tab-pane fade show active" id="report-content" role="tabpanel">
      <!-- Filter Section -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-lg-4">
              <label for="credit-class-filter" class="form-label fw-semibold"
                >{{ _('reports.credit_class') }}</label
              >
              <select id="credit-class-filter" class="form-select">
                <option value="">{{ _('reports.select_credit_class') }}</option>
              </select>
            </div>
            <div class="col-lg-4 d-none" id="session-filter-container">
              <label for="session-filter" class="form-label fw-semibold"
                >{{ _('reports.session') }}</label
              >
              <select id="session-filter" class="form-select" disabled>
                <option value="">{{ _('reports.all_sessions_today') }}</option>
              </select>
            </div>
            <div class="col-lg-4 col-xl-3 text-lg-end text-start">
              <button
                id="refresh-reports"
                class="btn btn-primary"
                type="button"
                disabled
              >
                <i class="fas fa-sync-alt me-2"></i>{{
                _('reports.refresh_report') }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <div id="filter-notice" class="alert alert-info">
        {{ _('reports.select_class_notice') }}
      </div>

      <!-- Loading Spinner -->
      <div id="loading-container" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">{{ _('common.loading') }}</span>
        </div>
        <p class="mt-3 text-muted">{{ _('reports.loading_data') }}</p>
      </div>

      <!-- Main Content -->
      <div id="main-content" class="d-none">
        <!-- Statistics Section -->
        <div id="stats-section" class="d-none">
          <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
              <div class="card stat-card bg-primary text-white shadow">
                <div class="card-body">
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <div>
                      <div class="text-white-50 small">
                        {{ _('reports.total_students') }}
                      </div>
                      <h3 class="mb-0" id="total-students">0</h3>
                    </div>
                    <div class="text-white-50">
                      <i class="fas fa-users fa-3x"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
              <div class="card stat-card bg-success text-white shadow">
                <div class="card-body">
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <div>
                      <div class="text-white-50 small">
                        {{ _('student.attended') }}
                      </div>
                      <h3 class="mb-0" id="attended-students">0</h3>
                    </div>
                    <div class="text-white-50">
                      <i class="fas fa-user-check fa-3x"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
              <div class="card stat-card bg-info text-white shadow">
                <div class="card-body">
                  <div>
                    <div class="text-white-50 small">
                      {{ _('reports.attendance_rate') }}
                    </div>
                    <h3 class="mb-0" id="attendance-rate">0%</h3>
                    <div class="progress mt-2 bg-white bg-opacity-25">
                      <div
                        id="attendance-rate-bar"
                        class="progress-bar bg-white progress-bar-initial"
                        role="progressbar"
                        aria-label="{{ _('reports.attendance_rate') }}"
                        aria-valuenow="0"
                        aria-valuemin="0"
                        aria-valuemax="100"
                      ></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
              <div class="card stat-card bg-warning text-white shadow">
                <div class="card-body">
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <div>
                      <div class="text-white-50 small">
                        {{ _('reports.avg_duration') }}
                      </div>
                      <h3 class="mb-0" id="avg-duration">
                        0 {{ _('attendance.minutes') }}
                      </h3>
                    </div>
                    <div class="text-white-50">
                      <i class="fas fa-clock fa-3x"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Attendance Tables Section -->
        <div id="attendance-section" class="d-none">
          <div class="row">
            <!-- Checked In Students -->
            <div class="col-lg-6 mb-4">
              <div class="card shadow">
                <div class="card-header bg-success text-white">
                  <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-sign-in-alt me-2"></i>{{
                    _('reports.students_present') }}
                  </h6>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table
                      class="table table-striped table-hover mb-0"
                      id="checked-in-table"
                    >
                      <thead>
                        <tr>
                          <th>{{ _('student.student_id') }}</th>
                          <th>{{ _('student.full_name') }}</th>
                          <th>{{ _('attendance.time_in') }}</th>
                          <th>{{ _('attendance.duration') }}</th>
                          <th>{{ _('common.actions') }}</th>
                        </tr>
                      </thead>
                      <tbody>
                        <!-- Data will be inserted here by JS -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- Checked Out Students -->
            <div class="col-lg-6 mb-4">
              <div class="card shadow">
                <div class="card-header bg-danger text-white">
                  <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-sign-out-alt me-2"></i>{{
                    _('reports.students_left') }}
                  </h6>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table
                      class="table table-striped table-hover mb-0"
                      id="checked-out-table"
                    >
                      <thead>
                        <tr>
                          <th>{{ _('student.student_id') }}</th>
                          <th>{{ _('student.full_name') }}</th>
                          <th>{{ _('attendance.time_in') }}</th>
                          <th>{{ _('attendance.time_out') }}</th>
                          <th>{{ _('reports.total_time') }}</th>
                          <th>{{ _('common.actions') }}</th>
                        </tr>
                      </thead>
                      <tbody>
                        <!-- Data will be inserted here by JS -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Chi Tiết Điểm Danh -->
<div
  class="modal fade"
  id="attendanceDetailModal"
  tabindex="-1"
  aria-labelledby="attendanceDetailModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="attendanceDetailModalLabel">
          <i class="fas fa-user-clock me-2"></i>{{ _('attendance.details') }}
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div id="detailContent">
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">{{ _('common.loading') }}</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          {{ _('common.close') }}
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script>
  // Translations for JavaScript
  const i18n = {
    selectCreditClass: "{{ _('reports.select_credit_class') }}",
    allSessionsToday: "{{ _('reports.all_sessions_today') }}",
    selectClassNotice: "{{ _('reports.select_class_notice') }}",
    loadingData: "{{ _('reports.loading_data') }}",
    noData: "{{ _('common.no_data') }}",
    minutes: "{{ _('attendance.minutes') }}",
    unknown: "{{ _('reports.unknown') }}",
    unknownDate: "{{ _('reports.unknown_date') }}",
    session: "{{ _('reports.session') }}",
    classPrefix: "{{ _('reports.class_prefix') }}",
    viewingReport: "{{ _('reports.viewing_report') }}",
    currentSession: "{{ _('reports.current_session') }}",
    noStudentsPresent: "{{ _('reports.no_students_present') }}",
    noStudentsLeft: "{{ _('reports.no_students_left') }}",
    notSelected: "{{ _('reports.not_selected') }}",
    loadError: "{{ _('messages.load_error') }}",
    loadSessionError: "{{ _('reports.load_session_error') }}",
    cannotLoadStats: "{{ _('reports.cannot_load_stats') }}",
    cannotLoadAttendance: "{{ _('reports.cannot_load_attendance') }}",
    cannotLoadCreditClasses: "{{ _('reports.cannot_load_credit_classes') }}",
    loadingSessions: "{{ _('reports.loading_sessions') }}",
    cannotLoadInit: "{{ _('reports.cannot_load_init') }}",
    viewDetails: "{{ _('common.view_details') }}",
    attendanceDetails: "Chi tiết điểm danh",
    noAttendanceHistory: "Chưa có lịch sử điểm danh",
    studentId: "{{ _('student.student_id') }}",
    totalRecords: "Tổng số buổi",
    date: "Ngày",
    timeIn: "{{ _('attendance.time_in') }}",
    timeOut: "{{ _('attendance.time_out') }}",
    duration: "Thời gian",
  };

  document.addEventListener("DOMContentLoaded", () => {
    const REFRESH_INTERVAL = 30000;
    const loadingContainer = document.getElementById("loading-container");
    const mainContent = document.getElementById("main-content");
    const statsSection = document.getElementById("stats-section");
    const attendanceSection = document.getElementById("attendance-section");
    const filterNotice = document.getElementById("filter-notice");

    const creditClassSelect = document.getElementById("credit-class-filter");
    const sessionSelect = document.getElementById("session-filter");
    const sessionContainer = document.getElementById(
      "session-filter-container"
    );
    const refreshButton = document.getElementById("refresh-reports");

    const totalStudentsEl = document.getElementById("total-students");
    const attendedStudentsEl = document.getElementById("attended-students");
    const attendanceRateEl = document.getElementById("attendance-rate");
    const attendanceRateBar = document.getElementById("attendance-rate-bar");
    const avgDurationEl = document.getElementById("avg-duration");
    const checkedInTableBody = document.querySelector(
      "#checked-in-table tbody"
    );
    const checkedOutTableBody = document.querySelector(
      "#checked-out-table tbody"
    );

    const emptyRow = (cols, message) =>
      `<tr><td colspan="${cols}" class="text-center text-muted py-4">${message}</td></tr>`;
    const escapeHtml = (value = "") =>
      String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    const formatTimeLabel = (value) => {
      if (!value) return "--:--";
      const date = new Date(value);
      return Number.isNaN(date.getTime())
        ? value
        : date.toLocaleTimeString("vi-VN", {
            hour: "2-digit",
            minute: "2-digit",
          });
    };
    const withTimestamp = (params = new URLSearchParams()) => {
      const query = new URLSearchParams(params);
      query.set("t", Date.now());
      return query.toString();
    };

    const creditClassMap = new Map();
    let currentCreditClassId = null;
    let currentSessionId = null;
    let refreshIntervalId = null;
    let isLoadingData = false;

    function setFilterNotice(message, type = "info") {
      filterNotice.className = `alert alert-${type}`;
      filterNotice.textContent = message;
      filterNotice.classList.remove("d-none");
    }

    function toggleDataSections(visible) {
      statsSection.classList.toggle("d-none", !visible);
      attendanceSection.classList.toggle("d-none", !visible);
    }

    function resetTables(message = i18n.noData) {
      checkedInTableBody.innerHTML = emptyRow(5, message);
      checkedOutTableBody.innerHTML = emptyRow(6, message);
      totalStudentsEl.textContent = 0;
      attendedStudentsEl.textContent = 0;
      attendanceRateEl.textContent = "0%";
      attendanceRateBar.style.width = "0%";
      attendanceRateBar.setAttribute("aria-valuenow", 0);
      avgDurationEl.textContent = `0 ${i18n.minutes}`;
    }

    function stopAutoRefresh() {
      if (refreshIntervalId) {
        clearInterval(refreshIntervalId);
        refreshIntervalId = null;
      }
    }

    function startAutoRefresh() {
      stopAutoRefresh();
      refreshIntervalId = setInterval(loadReports, REFRESH_INTERVAL);
    }

    async function populateCreditClasses() {
      const response = await fetch(`/api/credit-classes?${withTimestamp()}`);
      if (!response.ok) throw new Error(i18n.cannotLoadCreditClasses);
      const payload = await response.json();
      const classes = payload.data || [];

      creditClassSelect.innerHTML = `<option value="">${i18n.selectCreditClass}</option>`;
      creditClassMap.clear();

      (classes || []).forEach((cls) => {
        creditClassMap.set(String(cls.id), cls);
        const option = document.createElement("option");
        option.value = cls.id;
        option.textContent =
          cls.display_name ||
          cls.subject_name ||
          cls.credit_code ||
          `${i18n.classPrefix}${cls.id}`;
        creditClassSelect.appendChild(option);
      });
    }

    function formatSessionLabel(session) {
      let dateLabel = i18n.unknownDate;
      if (session.session_date) {
        const parsed = new Date(session.session_date);
        dateLabel = Number.isNaN(parsed.getTime())
          ? session.session_date
          : parsed.toLocaleDateString("vi-VN");
      }
      const statusLabel = session.status ? session.status.toUpperCase() : "--";
      return `${i18n.session} ${session.id} · ${dateLabel} · ${statusLabel}`;
    }

    async function loadSessionsForClass(classId) {
      sessionContainer.classList.remove("d-none");
      sessionSelect.disabled = true;
      sessionSelect.innerHTML = `<option value="">${i18n.allSessionsToday}</option>`;

      try {
        const response = await fetch(
          `/api/reports/credit-classes/${classId}/sessions?${withTimestamp()}`
        );
        if (!response.ok) throw new Error(i18n.loadSessionError);
        const payload = await response.json();
        if (!payload.success)
          throw new Error(payload.message || i18n.loadSessionError);

        const sessions = payload.sessions || [];
        sessions.forEach((session) => {
          const option = document.createElement("option");
          option.value = session.id;
          option.textContent = formatSessionLabel(session);
          sessionSelect.appendChild(option);
        });

        sessionSelect.disabled = false;
      } catch (error) {
        console.error(error);
        setFilterNotice(i18n.loadSessionError, "warning");
      }
    }

    async function loadReports() {
      if (!currentCreditClassId || isLoadingData) {
        return;
      }

      isLoadingData = true;
      setFilterNotice(i18n.loadingData, "secondary");

      const params = new URLSearchParams();
      params.set("credit_class_id", currentCreditClassId);
      if (currentSessionId) {
        params.set("session_id", currentSessionId);
      }

      try {
        const statsResponse = await fetch(
          `/api/statistics?${withTimestamp(params)}`,
          { headers: { "Cache-Control": "no-cache" } }
        );
        if (!statsResponse.ok) throw new Error(i18n.cannotLoadStats);
        const stats = await statsResponse.json();

        totalStudentsEl.textContent = stats.total_students;
        attendedStudentsEl.textContent = stats.attended_students;
        attendanceRateEl.textContent = `${stats.attendance_rate}%`;
        attendanceRateBar.style.width = `${stats.attendance_rate}%`;
        attendanceRateBar.setAttribute("aria-valuenow", stats.attendance_rate);
        avgDurationEl.textContent = `${stats.avg_duration_minutes} ${i18n.minutes}`;

        const attendanceResponse = await fetch(
          `/api/attendance/today?${withTimestamp(params)}`,
          { headers: { "Cache-Control": "no-cache" } }
        );
        if (!attendanceResponse.ok) throw new Error(i18n.cannotLoadAttendance);
        const attendance = await attendanceResponse.json();
        if (!attendance.success) {
          throw new Error(
            attendance.error || "Attendance API returned an error"
          );
        }

        checkedInTableBody.innerHTML = "";
        if (
          Array.isArray(attendance.checked_in) &&
          attendance.checked_in.length
        ) {
          attendance.checked_in.forEach((student) => {
            const checkInTime = formatTimeLabel(
              student.timestamp || student.check_in_time
            );
            const durationLabel =
              typeof student.duration_minutes === "number"
                ? `${student.duration_minutes} ${i18n.minutes}`
                : "--";
            const safeName = escapeHtml(student.full_name || i18n.unknown);
            const row = `
              <tr>
                <td>${escapeHtml(student.student_id || "--")}</td>
                <td>${safeName}</td>
                <td>${checkInTime}</td>
                <td>${durationLabel}</td>
                <td>
                  <button class="btn btn-sm btn-outline-primary js-view-details" title="${
                    i18n.viewDetails
                  }"
                          data-student-id="${escapeHtml(
                            student.student_id || ""
                          )}"
                          data-student-name="${safeName}">
                    <i class="fas fa-eye"></i>
                  </button>
                </td>
              </tr>`;
            checkedInTableBody.insertAdjacentHTML("beforeend", row);
          });
        } else {
          checkedInTableBody.innerHTML = emptyRow(5, i18n.noStudentsPresent);
        }

        checkedOutTableBody.innerHTML = "";
        if (
          Array.isArray(attendance.checked_out) &&
          attendance.checked_out.length
        ) {
          attendance.checked_out.forEach((student) => {
            const checkInTime = formatTimeLabel(
              student.timestamp || student.check_in_time
            );
            const checkOutTime = formatTimeLabel(student.checkout_time);
            const durationLabel =
              typeof student.duration_minutes === "number"
                ? `${student.duration_minutes} ${i18n.minutes}`
                : "--";
            const safeName = escapeHtml(student.full_name || i18n.unknown);
            const row = `
              <tr>
                <td>${escapeHtml(student.student_id || "--")}</td>
                <td>${safeName}</td>
                <td>${checkInTime}</td>
                <td>${checkOutTime}</td>
                <td>${durationLabel}</td>
                <td>
                  <button class="btn btn-sm btn-outline-primary js-view-details" title="${
                    i18n.viewDetails
                  }"
                          data-student-id="${escapeHtml(
                            student.student_id || ""
                          )}"
                          data-student-name="${safeName}">
                    <i class="fas fa-eye"></i>
                  </button>
                </td>
              </tr>`;
            checkedOutTableBody.insertAdjacentHTML("beforeend", row);
          });
        } else {
          checkedOutTableBody.innerHTML = emptyRow(6, i18n.noStudentsLeft);
        }

        const classInfo = creditClassMap.get(String(currentCreditClassId));
        let noticeMessage = classInfo
          ? `${i18n.viewingReport} ${
              classInfo.display_name ||
              classInfo.subject_name ||
              classInfo.credit_code
            }`
          : i18n.viewingReport;
        if (currentSessionId) {
          noticeMessage += ` · ${i18n.session} #${currentSessionId}`;
        } else if (attendance.session && attendance.session.status) {
          noticeMessage += ` · ${i18n.currentSession}: ${attendance.session.status}`;
        }
        setFilterNotice(noticeMessage, "success");
        toggleDataSections(true);
      } catch (error) {
        console.error("Error loading reports:", error);
        setFilterNotice(error.message || i18n.loadError, "danger");
        toggleDataSections(false);
        resetTables(i18n.loadError);
      } finally {
        isLoadingData = false;
      }
    }

    async function handleClassChange() {
      currentCreditClassId = creditClassSelect.value || null;
      currentSessionId = null;
      sessionSelect.value = "";
      stopAutoRefresh();

      if (!currentCreditClassId) {
        sessionContainer.classList.add("d-none");
        sessionSelect.disabled = true;
        refreshButton.disabled = true;
        setFilterNotice(i18n.selectClassNotice, "info");
        toggleDataSections(false);
        resetTables(i18n.notSelected);
        return;
      }

      refreshButton.disabled = false;
      setFilterNotice(i18n.loadingSessions, "secondary");
      await loadSessionsForClass(currentCreditClassId);
      await loadReports();
      startAutoRefresh();
    }

    async function handleSessionChange() {
      currentSessionId = sessionSelect.value || null;
      await loadReports();
    }

    refreshButton.addEventListener("click", () => loadReports());
    creditClassSelect.addEventListener("change", handleClassChange);
    sessionSelect.addEventListener("change", handleSessionChange);

    // Handle view details buttons
    document.addEventListener("click", async (e) => {
      const btn = e.target.closest(".js-view-details");
      if (!btn) return;

      const studentId = btn.dataset.studentId;
      const studentName = btn.dataset.studentName;

      if (!studentId) return;

      // Show modal
      const modal = new bootstrap.Modal(
        document.getElementById("attendanceDetailModal")
      );
      const modalTitle = document.getElementById("attendanceDetailModalLabel");
      const detailContent = document.getElementById("detailContent");

      modalTitle.innerHTML = `<i class="fas fa-user-clock me-2"></i>${
        i18n.attendanceDetails || "Chi tiết điểm danh"
      }: ${escapeHtml(studentName)}`;
      detailContent.innerHTML = `<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>`;
      modal.show();

      try {
        // Load attendance history
        const response = await fetch(
          `/api/attendance/history/${studentId}?limit=10`
        );
        if (!response.ok) throw new Error("Cannot load attendance history");

        const data = await response.json();
        const records = data.data || [];

        if (records.length === 0) {
          detailContent.innerHTML = `<div class="alert alert-info">${
            i18n.noAttendanceHistory || "Chưa có lịch sử điểm danh"
          }</div>`;
          return;
        }

        // Build detail view
        let html = `
          <div class="row mb-3">
            <div class="col-md-6">
              <strong>${i18n.studentId || "Mã SV"}:</strong> ${escapeHtml(
          studentId
        )}
            </div>
            <div class="col-md-6">
              <strong>${i18n.totalRecords || "Tổng số buổi"}:</strong> ${
          records.length
        }
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>${i18n.date || "Ngày"}</th>
                  <th>${i18n.timeIn || "Giờ vào"}</th>
                  <th>${i18n.timeOut || "Giờ ra"}</th>
                  <th>${i18n.duration || "Thời gian"}</th>
                  <th>${i18n.session || "Phiên"}</th>
                </tr>
              </thead>
              <tbody>
        `;

        records.forEach((record) => {
          const date = record.check_in_time
            ? new Date(record.check_in_time).toLocaleDateString("vi-VN")
            : "--";
          const timeIn = record.check_in_time
            ? new Date(record.check_in_time).toLocaleTimeString("vi-VN")
            : "--";
          const timeOut = record.checkout_time
            ? new Date(record.checkout_time).toLocaleTimeString("vi-VN")
            : "--";
          const duration = record.duration_minutes
            ? `${record.duration_minutes} ${i18n.minutes}`
            : "--";
          const session = record.session_id || "--";

          html += `
            <tr>
              <td>${date}</td>
              <td>${timeIn}</td>
              <td>${timeOut}</td>
              <td>${duration}</td>
              <td>${session}</td>
            </tr>
          `;
        });

        html += `
              </tbody>
            </table>
          </div>
        `;

        detailContent.innerHTML = html;
      } catch (error) {
        console.error("Error loading details:", error);
        detailContent.innerHTML = `<div class="alert alert-danger">${
          i18n.loadError || "Không thể tải chi tiết"
        }</div>`;
      }
    });

    (async () => {
      try {
        await populateCreditClasses();
        loadingContainer.classList.add("d-none");
        mainContent.classList.remove("d-none");
        setFilterNotice(i18n.selectClassNotice, "info");
      } catch (error) {
        console.error(error);
        loadingContainer.innerHTML = `<div class="alert alert-danger">${i18n.cannotLoadInit}</div>`;
      }
    })();
  });
</script>
{% endblock %}
