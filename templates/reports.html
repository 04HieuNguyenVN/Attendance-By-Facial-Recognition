<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o c√°o v√† th·ªëng k√™ - H·ªá th·ªëng ƒëi·ªÉm danh th√¥ng minh</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom CSS -->
    <link href="/static/css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-user-check me-2"></i>
                H·ªá th·ªëng ƒëi·ªÉm danh th√¥ng minh
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-home me-1"></i>Trang ch·ªß
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/students">
                            <i class="fas fa-users me-1"></i>Qu·∫£n l√Ω sinh vi√™n
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/reports">
                            <i class="fas fa-chart-bar me-1"></i>B√°o c√°o
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/settings">
                            <i class="fas fa-cog me-1"></i>C√†i ƒë·∫∑t
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>Admin
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/settings"><i class="fas fa-user-circle me-1"></i>H·ªì s∆°</a></li>
                            <li><a class="dropdown-item" href="/logout"><i class="fas fa-sign-out-alt me-1"></i>ƒêƒÉng xu·∫•t</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2><i class="fas fa-chart-bar me-2"></i>B√°o c√°o v√† th·ªëng k√™</h2>
                        <p class="text-muted mb-0">Theo d√µi v√† ph√¢n t√≠ch d·ªØ li·ªáu ƒëi·ªÉm danh</p>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="exportReport('excel')">
                            <i class="fas fa-file-excel me-1"></i>Xu·∫•t Excel
                        </button>
                        <button class="btn btn-danger" onclick="exportReport('pdf')">
                            <i class="fas fa-file-pdf me-1"></i>Xu·∫•t PDF
                        </button>
                        <button class="btn btn-primary" onclick="refreshReports()">
                            <i class="fas fa-sync-alt me-1"></i>L√†m m·ªõi
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Date Range Filter -->
        <div class="row mb-4">
            <div class="col-md-4">
                <label for="startDate" class="form-label">T·ª´ ng√†y</label>
                <input type="date" class="form-control" id="startDate" value="">
            </div>
            <div class="col-md-4">
                <label for="endDate" class="form-label">ƒê·∫øn ng√†y</label>
                <input type="date" class="form-control" id="endDate" value="">
            </div>
            <div class="col-md-4">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button class="btn btn-primary" onclick="filterReports()">
                        <i class="fas fa-filter me-1"></i>L·ªçc d·ªØ li·ªáu
                    </button>
                    <button class="btn btn-secondary" onclick="resetFilters()">
                        <i class="fas fa-undo me-1"></i>ƒê·∫∑t l·∫°i
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">T·ªïng sinh vi√™n</h6>
                                <h3 class="mb-0" id="totalStudents">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-users fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">ƒê√£ ƒëi·ªÉm danh</h6>
                                <h3 class="mb-0" id="attendedStudents">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-check-circle fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">T·ª∑ l·ªá ƒëi·ªÉm danh</h6>
                                <h3 class="mb-0" id="attendanceRate">0%</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-percentage fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">S·ªë ng√†y</h6>
                                <h3 class="mb-0" id="totalDays">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-calendar fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <!-- Attendance Trend Chart -->
            <div class="col-lg-8 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2"></i>Xu h∆∞·ªõng ƒëi·ªÉm danh theo ng√†y
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="attendanceTrendChart" height="100"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Class Distribution Chart -->
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-pie me-2"></i>Ph√¢n b·ªë theo l·ªõp
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="classDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Reports -->
        <div class="row">
            <!-- Attendance Details Table -->
            <div class="col-lg-8 mb-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-table me-2"></i>Chi ti·∫øt ƒëi·ªÉm danh
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="attendanceTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Ng√†y</th>
                                        <th>Sinh vi√™n</th>
                                        <th>L·ªõp</th>
                                        <th>Th·ªùi gian</th>
                                        <th>ƒê·ªô tin c·∫≠y</th>
                                        <th>Tr·∫°ng th√°i</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceTableBody">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Students -->
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header bg-warning text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-trophy me-2"></i>Sinh vi√™n ƒëi·ªÉm danh nhi·ªÅu nh·∫•t
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="topStudentsList">
                            <!-- Top students will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Report -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-file-alt me-2"></i>T√≥m t·∫Øt b√°o c√°o
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Th·ªëng k√™ t·ªïng quan</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success me-2"></i>T·ªïng s·ªë sinh vi√™n: <span id="summaryTotalStudents">0</span></li>
                                    <li><i class="fas fa-calendar-check text-primary me-2"></i>S·ªë ng√†y theo d√µi: <span id="summaryTotalDays">0</span></li>
                                    <li><i class="fas fa-user-check text-info me-2"></i>T·ªïng l∆∞·ª£t ƒëi·ªÉm danh: <span id="summaryTotalAttendance">0</span></li>
                                    <li><i class="fas fa-percentage text-warning me-2"></i>T·ª∑ l·ªá ƒëi·ªÉm danh trung b√¨nh: <span id="summaryAvgRate">0%</span></li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Ph√¢n t√≠ch</h6>
                                <div id="summaryAnalysis">
                                    <!-- Analysis will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light text-center text-muted py-3 mt-5">
        <div class="container">
            <small>&copy; 2024 H·ªá th·ªëng ƒëi·ªÉm danh th√¥ng minh. Ph√°t tri·ªÉn b·ªüi AI Assistant.</small>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="/static/js/app.js"></script>
    
    <script>
        class ReportsManager {
            constructor() {
                this.attendanceData = [];
                this.charts = {};
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setDefaultDateRange();
                this.loadReports();
            }

            setupEventListeners() {
                // Date inputs
                document.getElementById('startDate').addEventListener('change', () => {
                    this.filterReports();
                });
                document.getElementById('endDate').addEventListener('change', () => {
                    this.filterReports();
                });
            }

            setDefaultDateRange() {
                const today = new Date();
                const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                
                document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];
                document.getElementById('endDate').value = today.toISOString().split('T')[0];
            }

            async loadReports() {
                try {
                    await Promise.all([
                        this.loadStatistics(),
                        this.loadAttendanceHistory(),
                        this.loadCharts()
                    ]);
                } catch (error) {
                    console.error('Error loading reports:', error);
                    this.showNotification('L·ªói khi t·∫£i b√°o c√°o', 'error');
                }
            }

            async loadStatistics() {
                try {
                    const response = await fetch('/api/statistics');
                    if (!response.ok) throw new Error('Failed to load statistics');
                    
                    const stats = await response.json();
                    
                    document.getElementById('totalStudents').textContent = stats.total_students || 0;
                    document.getElementById('attendedStudents').textContent = stats.attended_students || 0;
                    document.getElementById('attendanceRate').textContent = (stats.attendance_rate || 0) + '%';
                    
                    // Update summary
                    document.getElementById('summaryTotalStudents').textContent = stats.total_students || 0;
                    document.getElementById('summaryTotalAttendance').textContent = stats.attended_students || 0;
                    document.getElementById('summaryAvgRate').textContent = (stats.attendance_rate || 0) + '%';
                    
                } catch (error) {
                    console.error('Error loading statistics:', error);
                }
            }

            async loadAttendanceHistory() {
                try {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    
                    const response = await fetch(`/api/attendance/history?start_date=${startDate}&end_date=${endDate}`);
                    if (!response.ok) throw new Error('Failed to load attendance history');
                    
                    this.attendanceData = await response.json();
                    this.renderAttendanceTable();
                    this.renderTopStudents();
                    this.updateSummary();
                    
                } catch (error) {
                    console.error('Error loading attendance history:', error);
                }
            }

            renderAttendanceTable() {
                const tbody = document.getElementById('attendanceTableBody');
                tbody.innerHTML = '';

                this.attendanceData.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(record.attendance_date).toLocaleDateString('vi-VN')}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                    ${record.student_name[0].toUpperCase()}
                                </div>
                                <div>
                                    <div class="fw-bold">${record.student_name}</div>
                                    <small class="text-muted">${record.student_id}</small>
                                </div>
                            </div>
                        </td>
                        <td><span class="badge bg-info">${record.class_name || 'N/A'}</span></td>
                        <td>${new Date(record.check_in_time).toLocaleTimeString('vi-VN')}</td>
                        <td>
                            <span class="badge ${record.confidence_score > 0.8 ? 'bg-success' : record.confidence_score > 0.6 ? 'bg-warning' : 'bg-danger'}">
                                ${(record.confidence_score * 100).toFixed(1)}%
                            </span>
                        </td>
                        <td><span class="badge bg-success">ƒê√£ ƒëi·ªÉm danh</span></td>
                    `;
                    tbody.appendChild(row);
                });
            }

            renderTopStudents() {
                const container = document.getElementById('topStudentsList');
                
                // Group by student and count attendance
                const studentCounts = {};
                this.attendanceData.forEach(record => {
                    const key = `${record.student_id}_${record.student_name}`;
                    studentCounts[key] = (studentCounts[key] || 0) + 1;
                });

                // Sort by count and get top 5
                const topStudents = Object.entries(studentCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);

                container.innerHTML = '';
                topStudents.forEach(([key, count], index) => {
                    const [studentId, studentName] = key.split('_');
                    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üèÖ';
                    
                    const item = document.createElement('div');
                    item.className = 'd-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded';
                    item.innerHTML = `
                        <div class="d-flex align-items-center">
                            <span class="me-2">${medal}</span>
                            <div>
                                <div class="fw-bold">${studentName}</div>
                                <small class="text-muted">${studentId}</small>
                            </div>
                        </div>
                        <span class="badge bg-primary">${count} l·∫ßn</span>
                    `;
                    container.appendChild(item);
                });
            }

            updateSummary() {
                const totalDays = new Set(this.attendanceData.map(r => r.attendance_date)).size;
                document.getElementById('totalDays').textContent = totalDays;
                document.getElementById('summaryTotalDays').textContent = totalDays;

                // Generate analysis
                const analysis = this.generateAnalysis();
                document.getElementById('summaryAnalysis').innerHTML = analysis;
            }

            generateAnalysis() {
                if (this.attendanceData.length === 0) {
                    return '<p class="text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch</p>';
                }

                const totalDays = new Set(this.attendanceData.map(r => r.attendance_date)).size;
                const avgPerDay = (this.attendanceData.length / totalDays).toFixed(1);
                
                let analysis = `
                    <ul class="list-unstyled">
                        <li><i class="fas fa-chart-line text-primary me-2"></i>Trung b√¨nh ${avgPerDay} l∆∞·ª£t ƒëi·ªÉm danh/ng√†y</li>
                `;

                if (totalDays >= 7) {
                    analysis += `<li><i class="fas fa-calendar-week text-info me-2"></i>Theo d√µi trong ${totalDays} ng√†y</li>`;
                }

                if (this.attendanceData.length > 0) {
                    const highConfidence = this.attendanceData.filter(r => r.confidence_score > 0.8).length;
                    const confidenceRate = ((highConfidence / this.attendanceData.length) * 100).toFixed(1);
                    analysis += `<li><i class="fas fa-eye text-success me-2"></i>${confidenceRate}% nh·∫≠n di·ªán v·ªõi ƒë·ªô tin c·∫≠y cao</li>`;
                }

                analysis += '</ul>';
                return analysis;
            }

            async loadCharts() {
                await this.createAttendanceTrendChart();
                await this.createClassDistributionChart();
            }

            async createAttendanceTrendChart() {
                const ctx = document.getElementById('attendanceTrendChart').getContext('2d');
                
                // Group data by date
                const dailyData = {};
                this.attendanceData.forEach(record => {
                    const date = record.attendance_date;
                    dailyData[date] = (dailyData[date] || 0) + 1;
                });

                const dates = Object.keys(dailyData).sort();
                const counts = dates.map(date => dailyData[date]);

                this.charts.trend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates.map(date => new Date(date).toLocaleDateString('vi-VN')),
                        datasets: [{
                            label: 'S·ªë l∆∞·ª£t ƒëi·ªÉm danh',
                            data: counts,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        }
                    }
                });
            }

            async createClassDistributionChart() {
                const ctx = document.getElementById('classDistributionChart').getContext('2d');
                
                // Group data by class
                const classData = {};
                this.attendanceData.forEach(record => {
                    const className = record.class_name || 'Ch∆∞a ph√¢n l·ªõp';
                    classData[className] = (classData[className] || 0) + 1;
                });

                const labels = Object.keys(classData);
                const data = Object.values(classData);
                const colors = [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                ];

                this.charts.distribution = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            }
                        }
                    }
                });
            }

            async filterReports() {
                await this.loadAttendanceHistory();
                await this.loadCharts();
            }

            async exportReport(format) {
                try {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    
                    const response = await fetch(`/api/reports/export?format=${format}&start_date=${startDate}&end_date=${endDate}`);
                    
                    if (!response.ok) throw new Error('Export failed');
                    
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `attendance_report_${startDate}_to_${endDate}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    this.showNotification(`Xu·∫•t b√°o c√°o ${format.toUpperCase()} th√†nh c√¥ng!`, 'success');
                } catch (error) {
                    console.error('Export error:', error);
                    this.showNotification('L·ªói khi xu·∫•t b√°o c√°o', 'error');
                }
            }

            showNotification(message, type = 'info', duration = 3000) {
                const notification = document.createElement('div');
                notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                
                const iconClass = {
                    'info': 'fas fa-info-circle',
                    'success': 'fas fa-check-circle',
                    'warning': 'fas fa-exclamation-triangle',
                    'error': 'fas fa-times-circle'
                }[type] || 'fas fa-info-circle';
                
                notification.innerHTML = `
                    <i class="${iconClass} me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, duration);
            }
        }

        // Initialize reports manager
        let reportsManager;
        document.addEventListener('DOMContentLoaded', () => {
            reportsManager = new ReportsManager();
        });

        // Global functions
        function filterReports() {
            if (reportsManager) {
                reportsManager.filterReports();
            }
        }

        function resetFilters() {
            if (reportsManager) {
                reportsManager.setDefaultDateRange();
                reportsManager.filterReports();
            }
        }

        function refreshReports() {
            if (reportsManager) {
                reportsManager.loadReports();
            }
        }

        function exportReport(format) {
            if (reportsManager) {
                reportsManager.exportReport(format);
            }
        }
    </script>
</body>
</html>
