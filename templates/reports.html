{% extends "base.html" %} {% block title %}Báo cáo & Thống kê{% endblock %} {%
block extra_css %}
<style>
  .stat-card h3 {
    font-size: 2.2rem;
  }
  .table-responsive {
    max-height: 500px;
  }
  .progress-bar-initial {
    width: 0%;
  }
</style>
{% endblock %} {% block content %}
<div class="container-fluid" id="reports-container">
  {% set page_title = 'Báo cáo & Thống kê' %} {% set page_subtitle = 'Thống kê
  điểm danh và các hoạt động trong ngày.' %} {% set page_icon = 'fas
  fa-chart-line' %} {% include 'components/page_header.html' %}

  <!-- Loading Spinner -->
  <div id="loading-container">
    {% set loading_text = 'Đang tải báo cáo...' %} {% include
    'components/loading_spinner.html' %}
  </div>

  <!-- Main content - hidden until data is loaded -->
  <div id="main-content" class="d-none">
    <!-- Statistics Cards -->
    <div class="row mb-4">
      <div class="col-xl-3 col-md-6 mb-4">
        <div class="card h-100 border-start-primary shadow py-2">
          <div class="card-body">
            <div class="row no-gutters align-items-center">
              <div class="col mr-2">
                <div
                  class="text-xs font-weight-bold text-primary text-uppercase mb-1"
                >
                  Tổng số sinh viên
                </div>
                <div
                  id="total-students"
                  class="h5 mb-0 font-weight-bold text-gray-800"
                >
                  0
                </div>
              </div>
              <div class="col-auto">
                <i class="fas fa-users fa-2x text-gray-300"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-4">
        <div class="card h-100 border-start-success shadow py-2">
          <div class="card-body">
            <div class="row no-gutters align-items-center">
              <div class="col mr-2">
                <div
                  class="text-xs font-weight-bold text-success text-uppercase mb-1"
                >
                  Đã điểm danh
                </div>
                <div
                  id="attended-students"
                  class="h5 mb-0 font-weight-bold text-gray-800"
                >
                  0
                </div>
              </div>
              <div class="col-auto">
                <i class="fas fa-user-check fa-2x text-gray-300"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-4">
        <div class="card h-100 border-start-info shadow py-2">
          <div class="card-body">
            <div class="row no-gutters align-items-center">
              <div class="col mr-2">
                <div
                  class="text-xs font-weight-bold text-info text-uppercase mb-1"
                >
                  Tỷ lệ điểm danh
                </div>
                <div class="row no-gutters align-items-center">
                  <div class="col-auto">
                    <div
                      id="attendance-rate"
                      class="h5 mb-0 mr-3 font-weight-bold text-gray-800"
                    >
                      0%
                    </div>
                  </div>
                  <div class="col">
                    <div class="progress progress-sm mr-2">
                      <div
                        id="attendance-rate-bar"
                        class="progress-bar bg-info progress-bar-initial"
                        role="progressbar"
                        aria-label="Tỷ lệ điểm danh"
                        aria-valuenow="0"
                        aria-valuemin="0"
                        aria-valuemax="100"
                      ></div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-auto">
                <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-4">
        <div class="card h-100 border-start-warning shadow py-2">
          <div class="card-body">
            <div class="row no-gutters align-items-center">
              <div class="col mr-2">
                <div
                  class="text-xs font-weight-bold text-warning text-uppercase mb-1"
                >
                  Thời gian có mặt (TB)
                </div>
                <div
                  id="avg-duration"
                  class="h5 mb-0 font-weight-bold text-gray-800"
                >
                  0 phút
                </div>
              </div>
              <div class="col-auto">
                <i class="fas fa-clock fa-2x text-gray-300"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Attendance Lists -->
    <div class="row">
      <!-- Checked In Students -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow">
          <div class="card-header bg-success text-white">
            <h6 class="m-0 font-weight-bold">
              <i class="fas fa-sign-in-alt me-2"></i>Sinh viên đang có mặt
            </h6>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table
                class="table table-striped table-hover mb-0"
                id="checked-in-table"
              >
                <thead>
                  <tr>
                    <th>Mã SV</th>
                    <th>Họ tên</th>
                    <th>Thời gian vào</th>
                    <th>Thời gian có mặt</th>
                    <th>Hành động</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Data will be inserted here by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Checked Out Students -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow">
          <div class="card-header bg-danger text-white">
            <h6 class="m-0 font-weight-bold">
              <i class="fas fa-sign-out-alt me-2"></i>Sinh viên đã về
            </h6>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table
                class="table table-striped table-hover mb-0"
                id="checked-out-table"
              >
                <thead>
                  <tr>
                    <th>Mã SV</th>
                    <th>Họ tên</th>
                    <th>Thời gian vào</th>
                    <th>Thời gian ra</th>
                    <th>Tổng thời gian</th>
                    <th>Hành động</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Data will be inserted here by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const loadingContainer = document.getElementById("loading-container");
    const mainContent = document.getElementById("main-content");

    const totalStudentsEl = document.getElementById("total-students");
    const attendedStudentsEl = document.getElementById("attended-students");
    const attendanceRateEl = document.getElementById("attendance-rate");
    const attendanceRateBar = document.getElementById("attendance-rate-bar");
    const avgDurationEl = document.getElementById("avg-duration");

    const checkedInTableBody = document.querySelector(
      "#checked-in-table tbody"
    );
    const checkedOutTableBody = document.querySelector(
      "#checked-out-table tbody"
    );

    const emptyRow = (cols, message) =>
      `<tr><td colspan="${cols}" class="text-center text-muted py-4">${message}</td></tr>`;
    const escapeHtml = (value = "") =>
      String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    const formatTimeLabel = (value) => {
      if (!value) {
        return "--:--";
      }
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) {
        return value;
      }
      return date.toLocaleTimeString("vi-VN");
    };

    async function loadReports() {
      try {
        // Fetch statistics
        const statsResponse = await fetch(`/api/statistics?t=${Date.now()}`, {
          headers: { "Cache-Control": "no-cache" },
        });
        if (!statsResponse.ok) throw new Error("Failed to load statistics");
        const stats = await statsResponse.json();

        totalStudentsEl.textContent = stats.total_students;
        attendedStudentsEl.textContent = stats.attended_students;
        attendanceRateEl.textContent = `${stats.attendance_rate}%`;
        attendanceRateBar.style.width = `${stats.attendance_rate}%`;
        attendanceRateBar.setAttribute("aria-valuenow", stats.attendance_rate);
        avgDurationEl.textContent = `${stats.avg_duration_minutes} phút`;

        // Fetch attendance data
        const attendanceResponse = await fetch(
          `/api/attendance/today?t=${Date.now()}`,
          {
            headers: { "Cache-Control": "no-cache" },
          }
        );
        if (!attendanceResponse.ok)
          throw new Error("Failed to load attendance data");
        const attendance = await attendanceResponse.json();
        if (!attendance.success)
          throw new Error(
            attendance.error || "Attendance API returned an error"
          );

        // Populate checked-in table
        checkedInTableBody.innerHTML = "";
        if (attendance.checked_in && attendance.checked_in.length > 0) {
          attendance.checked_in.forEach((student) => {
            const checkInTime = formatTimeLabel(student.timestamp);
            const durationLabel =
              typeof student.duration_minutes === "number"
                ? `${student.duration_minutes} phút`
                : "--";
            const safeName = escapeHtml(student.full_name || "Không rõ");
            const actionBtn = `
                        <button class="btn btn-sm btn-outline-primary js-view-details"
                                data-student-id="${escapeHtml(
                                  student.student_id || ""
                                )}"
                                data-student-name="${safeName}">
                            <i class="fas fa-eye"></i>
                        </button>`;
            const row = `
                        <tr>
                            <td>${escapeHtml(student.student_id || "--")}</td>
                            <td>${safeName}</td>
                            <td>${checkInTime}</td>
                            <td>${durationLabel}</td>
                            <td>${actionBtn}</td>
                        </tr>
                    `;
            checkedInTableBody.innerHTML += row;
          });
        } else {
          checkedInTableBody.innerHTML = emptyRow(
            5,
            "Chưa có sinh viên nào có mặt."
          );
        }

        // Populate checked-out table
        checkedOutTableBody.innerHTML = "";
        if (attendance.checked_out && attendance.checked_out.length > 0) {
          attendance.checked_out.forEach((student) => {
            const checkInTime = formatTimeLabel(student.timestamp);
            const checkOutTime = formatTimeLabel(student.checkout_time);
            const safeName = escapeHtml(student.full_name || "Không rõ");
            const actionBtn = `
                        <button class="btn btn-sm btn-outline-primary js-view-details"
                                data-student-id="${escapeHtml(
                                  student.student_id || ""
                                )}"
                                data-student-name="${safeName}">
                            <i class="fas fa-eye"></i>
                        </button>`;
            const row = `
                        <tr>
                            <td>${escapeHtml(student.student_id || "--")}</td>
                            <td>${safeName}</td>
                            <td>${checkInTime}</td>
                            <td>${checkOutTime}</td>
                            <td>${
                              typeof student.duration_minutes === "number"
                                ? `${student.duration_minutes} phút`
                                : "--"
                            }</td>
                            <td>${actionBtn}</td>
                        </tr>
                    `;
            checkedOutTableBody.innerHTML += row;
          });
        } else {
          checkedOutTableBody.innerHTML = emptyRow(
            6,
            "Chưa có sinh viên nào ra về."
          );
        }

        // Show content
        loadingContainer.classList.add("d-none");
        mainContent.classList.remove("d-none");
      } catch (error) {
        console.error("Error loading reports:", error);
        loadingContainer.innerHTML = `<div class="alert alert-danger">Không thể tải báo cáo. Vui lòng thử lại sau.</div>`;
      }
    }

    // Initial load
    loadReports();

    // Auto-refresh every 30 seconds
    setInterval(loadReports, 30000);
  });
</script>
{% endblock %}
