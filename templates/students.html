{% extends 'base.html' %}
{% set active_page = 'students' %}

{% block title %}{{ _('nav.students') }} - {{ _('app_name') }}{% endblock %}

{% block extra_css %}
<style>
    .student-avatar {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 50%;
    }
    .action-buttons .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="fas fa-users me-2"></i>{{ _('nav.students') }}</h2>
                <p class="text-muted mb-0">{{ _('student.manage_desc') }}</p>
            </div>
            <div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                    <i class="fas fa-plus me-1"></i>{{ _('student.add_student') }}
                </button>
                <button class="btn btn-success" onclick="refreshStudents()">
                    <i class="fas fa-sync-alt me-1"></i>{{ _('common.refresh_btn') }}
                </button>
            </div>
        </div>
    </div>
</div>

        <!-- Search and Filter -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" placeholder="{{ _('student.search_placeholder') }}">
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="classFilter" aria-label="{{ _('student.filter_class') }}">
                    <option value="">{{ _('student.all_classes') }}</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="statusFilter" aria-label="{{ _('student.filter_status') }}">
                    <option value="">{{ _('student.all_statuses') }}</option>
                    <option value="active">{{ _('student.active') }}</option>
                    <option value="inactive">{{ _('student.inactive') }}</option>
                </select>
            </div>
        </div>

        <!-- Students Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list me-2"></i>{{ _('student.list_title') }}
                            <span class="badge bg-light text-dark ms-2" id="studentCount">0</span>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="studentsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th width="5%">#</th>
                                        <th width="15%">{{ _('student.student_id') }}</th>
                                        <th width="25%">{{ _('student.full_name') }}</th>
                                        <th width="15%">{{ _('student.class') }}</th>
                                        <th width="15%">{{ _('student.email') }}</th>
                                        <th width="10%">{{ _('student.phone') }}</th>
                                        <th width="10%">{{ _('common.status') }}</th>
                                        <th width="5%">{{ _('common.actions') }}</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody">
                                    <!-- Students will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus me-2"></i>{{ _('student.add_new') }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addStudentForm">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="studentId" class="form-label">{{ _('student.student_id') }} <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="studentId" name="student_id" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="fullName" class="form-label">{{ _('student.full_name') }} <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="fullName" name="full_name" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">{{ _('student.email') }}</label>
                                <input type="email" class="form-control" id="email" name="email">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label">{{ _('student.phone') }}</label>
                                <input type="tel" class="form-control" id="phone" name="phone">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="className" class="form-label">{{ _('student.class') }}</label>
                                <select class="form-select" id="className" name="class_name">
                                    <option value="">{{ _('student.select_class') }}</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="faceImage" class="form-label">{{ _('student.face_image') }}</label>
                                <input type="file" class="form-control" id="faceImage" name="face_images" accept="image/*" multiple required>
                                <div class="form-text">{{ _('student.face_image_hint') }}</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>{{ _('common.note') }}:</strong> {{ _('student.add_note') }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('common.cancel') }}</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>{{ _('student.save_student') }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal fade" id="editStudentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-edit me-2"></i>{{ _('student.edit_student') }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editStudentForm">
                    <div class="modal-body">
                        <input type="hidden" id="editStudentId" name="student_id">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editFullName" class="form-label">{{ _('student.full_name') }} <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editFullName" name="full_name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editEmail" class="form-label">{{ _('student.email') }}</label>
                                <input type="email" class="form-control" id="editEmail" name="email">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editPhone" class="form-label">{{ _('student.phone') }}</label>
                                <input type="tel" class="form-control" id="editPhone" name="phone">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editClassName" class="form-label">{{ _('student.class') }}</label>
                                <select class="form-select" id="editClassName" name="class_name">
                                    <option value="">{{ _('student.select_class') }}</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editFaceImage" class="form-label">{{ _('student.new_face_image') }}</label>
                                <input type="file" class="form-control" id="editFaceImage" name="face_images" accept="image/*" multiple>
                                <div class="form-text">{{ _('student.edit_face_image_hint') }}</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ _('common.status') }}</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editIsActive" name="is_active" checked>
                                    <label class="form-check-label" for="editIsActive">
                                        {{ _('student.active') }}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('common.cancel') }}</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>{{ _('common.update') }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>{{ _('common.confirm_delete') }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>{{ _('student.delete_confirm') }} <strong id="deleteStudentName"></strong>?</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-warning me-2"></i>
                        <strong>{{ _('common.warning') }}:</strong> {{ _('student.delete_warning') }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('common.cancel') }}</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-1"></i>{{ _('student.delete_student') }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Translations for JavaScript
        const i18n = {
            allClasses: "{{ _('student.all_classes') }}",
            selectClass: "{{ _('student.select_class') }}",
            noClassName: "{{ _('student.no_class_name') }}",
            noEmail: "{{ _('student.no_email') }}",
            notAssigned: "{{ _('student.not_assigned') }}",
            active: "{{ _('student.active') }}",
            inactive: "{{ _('student.inactive') }}",
            edit: "{{ _('common.edit') }}",
            delete: "{{ _('common.delete') }}",
            loadError: "{{ _('messages.load_error') }}",
            addSuccess: "{{ _('messages.add_success') }}",
            updateSuccess: "{{ _('messages.update_success') }}",
            deleteSuccess: "{{ _('messages.delete_success') }}",
            addError: "{{ _('messages.add_error') }}",
            updateError: "{{ _('messages.update_error') }}",
            deleteError: "{{ _('messages.delete_error') }}",
            minFaceWarning: "{{ _('student.min_face_warning') }}",
            sv: "{{ _('student.sv') }}"
        };

        class StudentManager {
            constructor() {
                this.students = [];
                this.filteredStudents = [];
                this.currentStudentId = null;
                this.classes = [];
                this.classesPromise = null;
                this.minFaceSamples = 3;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadClasses();
                this.loadStudents();
            }

            setupEventListeners() {
                // Search input
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.filterStudents();
                });

                // Filter selects
                document.getElementById('classFilter').addEventListener('change', () => {
                    this.filterStudents();
                });

                document.getElementById('statusFilter').addEventListener('change', () => {
                    this.filterStudents();
                });

                // Add student form
                document.getElementById('addStudentForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addStudent();
                });

                // Edit student form
                document.getElementById('editStudentForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.updateStudent();
                });

                // Delete confirmation
                document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                    this.deleteStudent();
                });
            }

            async loadStudents() {
                try {
                    const response = await fetch('/api/students');
                    if (!response.ok) throw new Error('Failed to load students');
                    
                    const result = await response.json();
                    this.students = result.data || [];
                    this.filteredStudents = [...this.students];
                    this.renderStudents();
                    this.updateStudentCount();
                } catch (error) {
                    console.error('Error loading students:', error);
                    this.showNotification(i18n.loadError, 'error');
                }
            }

            async loadClasses(forceReload = false) {
                if (!forceReload && this.classes.length) {
                    return this.classes;
                }
                if (!forceReload && this.classesPromise) {
                    return this.classesPromise;
                }

                this.classesPromise = (async () => {
                    try {
                        const response = await fetch('/api/classes');
                        if (!response.ok) throw new Error('Failed to load classes');
                        const result = await response.json();
                        this.classes = result.success ? result.data || [] : [];
                    } catch (error) {
                        console.error('Error loading classes:', error);
                        this.classes = [];
                    }
                    this.populateClassSelects();
                    return this.classes;
                })();

                const classes = await this.classesPromise;
                this.classesPromise = null;
                return classes;
            }

            populateClassSelects() {
                this.populateSelect(
                    document.getElementById('classFilter'),
                    this.classes,
                    { includeAll: true, label: i18n.allClasses, showCounts: true }
                );
                this.populateSelect(
                    document.getElementById('className'),
                    this.classes,
                    { label: i18n.selectClass }
                );
                this.populateSelect(
                    document.getElementById('editClassName'),
                    this.classes,
                    { label: i18n.selectClass }
                );
            }

            populateSelect(selectEl, classes, options = {}) {
                if (!selectEl) return;
                const { label = i18n.selectClass, showCounts = false } = options;
                const previousValue = selectEl.value;
                selectEl.innerHTML = '';

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = label;
                selectEl.appendChild(defaultOption);

                classes.forEach((cls) => {
                    const option = document.createElement('option');
                    option.value = cls.class_name || cls.class_code || '';
                    const pieces = [cls.class_name || cls.class_code || i18n.noClassName];
                    if (cls.class_code && cls.class_code !== cls.class_name) {
                        pieces.push(cls.class_code);
                    }
                    if (showCounts && typeof cls.student_count === 'number') {
                        pieces.push(`${cls.student_count} ${i18n.sv}`);
                    }
                    option.textContent = pieces.join(' â€¢ ');
                    selectEl.appendChild(option);
                });

                if (previousValue) {
                    selectEl.value = previousValue;
                }
            }

            filterStudents() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const classFilter = document.getElementById('classFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;

                this.filteredStudents = this.students.filter(student => {
                    const matchesSearch = !searchTerm || 
                        student.full_name.toLowerCase().includes(searchTerm) ||
                        student.student_id.toLowerCase().includes(searchTerm) ||
                        (student.email && student.email.toLowerCase().includes(searchTerm));

                    const matchesClass = !classFilter || student.class_name === classFilter;
                    const matchesStatus = !statusFilter || 
                        (statusFilter === 'active' && student.is_active) ||
                        (statusFilter === 'inactive' && !student.is_active);

                    return matchesSearch && matchesClass && matchesStatus;
                });

                this.renderStudents();
                this.updateStudentCount();
            }

            renderStudents() {
                const tbody = document.getElementById('studentsTableBody');
                tbody.innerHTML = '';

                this.filteredStudents.forEach((student, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td><code>${student.student_id}</code></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                    ${student.full_name[0].toUpperCase()}
                                </div>
                                <div>
                                    <div class="fw-bold">${student.full_name}</div>
                                    <small class="text-muted">${student.email || i18n.noEmail}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-info">${student.class_name || i18n.notAssigned}</span>
                        </td>
                        <td>${student.email || '-'}</td>
                        <td>${student.phone || '-'}</td>
                        <td>
                            <span class="badge ${student.is_active ? 'bg-success' : 'bg-secondary'}">
                                ${student.is_active ? i18n.active : i18n.inactive}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="studentManager.editStudent('${student.student_id}')" title="${i18n.edit}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="studentManager.confirmDelete('${student.student_id}', '${student.full_name}')" title="${i18n.delete}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            updateStudentCount() {
                const countElement = document.getElementById('studentCount');
                if (countElement) {
                    countElement.textContent = this.filteredStudents.length;
                }
            }

            async addStudent() {
                const form = document.getElementById('addStudentForm');
                const faceInput = document.getElementById('faceImage');
                const selectedFaces = faceInput && faceInput.files ? faceInput.files.length : 0;
                if (selectedFaces < this.minFaceSamples) {
                    this.showNotification(i18n.minFaceWarning.replace('{n}', this.minFaceSamples), 'warning');
                    faceInput && faceInput.focus();
                    return;
                }
                const formData = new FormData(form);

                try {
                    const response = await fetch('/api/students', {
                        method: 'POST',
                        body: formData
                    });

                    let result = null;
                    try {
                        result = await response.json();
                    } catch (parseError) {
                        result = null;
                    }

                    if (!response.ok || (result && result.success === false)) {
                        const message = (result && (result.message || result.error)) || i18n.addError;
                        throw new Error(message);
                    }

                    const credentials = result && result.credentials ? result.credentials : null;
                    this.showNotification(i18n.addSuccess, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
                    form.reset();
                    await this.loadStudents();
                    await this.loadClasses(true);

                    if (credentials && typeof window.showCredentialModal === 'function') {
                        window.showCredentialModal(credentials);
                    }
                } catch (error) {
                    console.error('Error adding student:', error);
                    this.showNotification(i18n.addError + ': ' + error.message, 'error');
                }
            }

            async editStudent(studentId) {
                const student = this.students.find(s => s.student_id === studentId);
                if (!student) return;

                await this.loadClasses();

                // Populate edit form
                document.getElementById('editStudentId').value = student.student_id;
                document.getElementById('editFullName').value = student.full_name;
                document.getElementById('editEmail').value = student.email || '';
                document.getElementById('editPhone').value = student.phone || '';
                document.getElementById('editClassName').value = student.class_name || '';
                document.getElementById('editIsActive').checked = student.is_active;

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editStudentModal'));
                modal.show();
            }

            async updateStudent() {
                const form = document.getElementById('editStudentForm');
                const faceInput = document.getElementById('editFaceImage');
                const selectedFaces = faceInput && faceInput.files ? faceInput.files.length : 0;
                if (selectedFaces > 0 && selectedFaces < this.minFaceSamples) {
                    this.showNotification(i18n.minFaceWarning.replace('{n}', this.minFaceSamples), 'warning');
                    faceInput && faceInput.focus();
                    return;
                }
                const formData = new FormData(form);
                const isActiveCheckbox = document.getElementById('editIsActive');
                if (isActiveCheckbox) {
                    formData.set('is_active', isActiveCheckbox.checked ? '1' : '0');
                }
                const studentId = document.getElementById('editStudentId').value;

                try {
                    const response = await fetch(`/api/students/${studentId}`, {
                        method: 'PUT',
                        body: formData
                    });

                    let result = null;
                    try {
                        result = await response.json();
                    } catch (parseError) {
                        result = null;
                    }

                    if (!response.ok || (result && result.success === false)) {
                        const message = (result && (result.message || result.error)) || i18n.updateError;
                        throw new Error(message);
                    }

                    this.showNotification(i18n.updateSuccess, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
                    await this.loadStudents();
                    await this.loadClasses(true);
                } catch (error) {
                    console.error('Error updating student:', error);
                    this.showNotification(i18n.updateError + ': ' + error.message, 'error');
                }
            }

            confirmDelete(studentId, studentName) {
                this.currentStudentId = studentId;
                document.getElementById('deleteStudentName').textContent = studentName;
                
                const modal = new bootstrap.Modal(document.getElementById('deleteStudentModal'));
                modal.show();
            }

            async deleteStudent() {
                if (!this.currentStudentId) return;

                try {
                    const response = await fetch(`/api/students/${this.currentStudentId}?permanent=1`, {
                        method: 'DELETE'
                    });

                    let result = null;
                    try {
                        result = await response.json();
                    } catch (parseError) {
                        result = null;
                    }

                    if (!response.ok || (result && result.success === false)) {
                        const message = (result && (result.message || result.error)) || i18n.deleteError;
                        throw new Error(message);
                    }

                    this.showNotification(i18n.deleteSuccess, 'success');
                } catch (error) {
                    console.error('Error deleting student:', error);
                    this.showNotification(i18n.deleteError + ': ' + error.message, 'error');
                } finally {
                    const modalElement = document.getElementById('deleteStudentModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                    await this.loadStudents();
                    await this.loadClasses(true);
                    this.currentStudentId = null;
                }
            }

            showNotification(message, type = 'info', duration = 3000) {
                const notification = document.createElement('div');
                notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                
                const iconClass = {
                    'info': 'fas fa-info-circle',
                    'success': 'fas fa-check-circle',
                    'warning': 'fas fa-exclamation-triangle',
                    'error': 'fas fa-times-circle'
                }[type] || 'fas fa-info-circle';
                
                notification.innerHTML = `
                    <i class="${iconClass} me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, duration);
            }
        }

        // Initialize student manager
        let studentManager;
        document.addEventListener('DOMContentLoaded', () => {
            studentManager = new StudentManager();
        });

        // Global functions
        function refreshStudents() {
            if (studentManager) {
                studentManager.loadStudents();
            }
        }
    </script>
{% endblock %}
